<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>COVID-19 statistics by US state: scaled 7-day average - Witulski</title>
  <link rel="stylesheet" href="src/bootstrap.min.css">
  <link rel="stylesheet" href="src/styles.css">
  <script src='src/d3.min.js'></script>
  <script src='src/script.js'></script>
</head>

<body>
  <div class="container" id="container">
    <div class="page-header">
      <h1>7-day average of new COVID-19 cases by US state, scaled by population</h1>
      <p>
        Last updated on <span id="date">July 22, 2020</span> with data through <span id="lastData">July 21, 2020</span>. 
      </p>
      <p>
        Click state names to show their graphs individually.
        Works best on mobile if you turn the phone sideways.
        Developed by <a href="https://cwitulski.com">Christopher Witulski</a>.
      </p>
      <p>
        <a href="index.html" class="btn btn-primary">Total cases</a>
        <a href='scaled_cases.html' class='btn btn-primary'>Cases by population</a>
        <a href='deaths.html' class='btn btn-primary'>Total deaths</a>
        <a href='averages.html' class='btn btn-primary'>Daily new cases</a>
        <a href='scaled_averages.html' class='btn btn-default'>Daily new cases per 100k</a>
      </p>
    </div>

    <script>
      svg = buildChart({ top: 30, right: 50, bottom: 320, left: 20 });
      chartTitle('Seven day rolling average per 100,000 of population');

      // Set the ranges
      var x = d3.time.scale().range([0, width]);
      var y = d3.scale.linear().range([height, 0]);

      // build tooltip
      var tooltip = d3.select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

      var showTooltip = function (current) {
        tooltip.transition()
          .duration(100)
          .style('opacity', .9);

        tooltip.html(function () {
          return "<b>" + current.name +
            "</b> max: " + Math.round(current.maxScaledAverages).toLocaleString() +
            " current: " + Math.round(Number(current.scaledAverages[current.scaledAverages.length - 1])).toLocaleString() +
            "<br>yesterday's cases: " + Math.round(current.averages[current.averages.length - 1] * 100000.0 / current.population).toLocaleString();
        })
          .style('left', (d3.event.pageX - 150) + 'px')
          .style('top', (d3.event.pageY - 60) + 'px');
      }

      // Get the data
      d3.json("data.json", function (error, data) {

        // Dynamically scale the range of the data
        var dayOne = new Date(2020, 0, 21);
        var yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000);
        x.domain([dayOne, yesterday]);
        y.domain([0, data.maxScaledAverages]);

        addAxes(x, y);

        // sort data and loop through each state
        var stateData = Object.entries(data.states).sort(
          function (a, b) { return a[0] > b[0]; }
        );

        stateData.forEach(function (d, i) {
          // get object from iterator array
          d = d[1];

          // add dates for x values
          var pairs = [];
          for (var day = 0; day < data.totalDays; day++) {
            let currentDay = new Date(dayOne.valueOf() + day * 24 * 60 * 60 * 1000);
            pairs.push({ "date": currentDay, "y": d.scaledAverages[day] });
          };

          buildPaths(d, pairs, pathFunctionTime);
          buildLegend(d, i);
        });
      });

    </script>

    <p>
      This chart tracks the seven day average of cases of COVID-19 across the USA. The data comes from the New York
      Times
      (see <a
        href='https://www.nytimes.com/article/coronavirus-county-data-us.html?action=click&module=Spotlight&pgtype=Homepage'>here
        for more information</a> and <a href='https://github.com/nytimes/covid-19-data'>here for the GitHub data</a>).
      The
      idea for the chart comes from <a
        href="https://ourworldindata.org/grapher/covid-confirmed-cases-since-100th-case">this similar one from Our World
        in Data</a>.
    </p>
    <p>
      I wouldn't depend on this for much, it's mostly a chance for me to see a graph that I wish were easier to find
      while
      checking to see if I remember how to use D3.js.
    </p>
  </div>
  <script data-goatcounter="https://witulski.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>